// Версия синтаксиса
syntax = 'proto3';

//Импорт определений
import "components.proto";
import "backup.proto";

package alpha.protort.protocol.deploy;

message NodeInfo
{
    string name = 1;// Имя ноды
    string address = 2;// Адрес
    uint32 port = 3;// Порт
    backup.BackupStatus backupStatus = 4;
}

message NodeInfoList
{
    repeated NodeInfo node_info = 1;
}

message Instance
{
    string name = 1;// Имя комонента
    ComponentKind kind = 2;// Тип компонента
}

message InstanceList
{
    repeated Instance instance = 1;
}

// указывает, что компонет относиться к текущей ноде 
message Map
{
    string node_name = 1;
    string instance_name = 2;
}

message MapList
{
    repeated Map map = 1;
}

message Connection
{
    ComponentEndpoint source = 1;
    ComponentEndpoint destination = 2;
}

message ConnectionList
{
    repeated Connection connection = 1;
}

enum PacketKind
{
    // Деплой конфигурации узла
    DeployConfig = 0;
    // Запрос конфигурации узла
    GetConfig = 1;
    // Запуск узла (старт роутера и компонентов)
    Start = 2;
    // Останов узла
    Stop = 3;
    // Запрос статуса узла
    GetStatus = 4;
    // Обновить схему развёрывания на лету
    // TODO
    Update = 5;   
    Switch = 6;
}

// Конфигурация
message Config
{
    NodeInfo this_node_info = 1;
    repeated NodeInfo node_infos = 2;
    repeated Instance instances = 3;
    repeated Map maps = 4;
    repeated Connection connections = 5;
}

// Деплой конфигурации узла
message DeployConfigRequest
{
    Config config = 1;
}

message DeployConfigResponse
{
    // TODO
}

// Запрос конфигурации узла
message GetConfigRequest
{
}

message GetConfigResponse
{
    Config config = 1;
}

// Запуск узла
message StartRequest
{
    // TODO
}

message StartResponse
{
    // TODO
}

// Останов узла
message StopRequest
{
    // TODO
}

message StopResponse
{
    // TODO
}

// Запрос статуса узла
message StatusRequest
{
    // TODO
}


// Ответ на запрос статуса сетевого узла
message StatusResponse
{
    string node_name = 1;// Имя узла, предоставившего свой статус
    uint32 in_packets_count = 2;// Счётчик входящих пакетов узла
    uint32 out_packets_count = 3;// Счётчик исходящих пакетов узла
    uint32 in_bytes_count = 4;// Количество входящих байт
    uint32 out_bytes_count = 5;// Количество исходящих байт
    uint32 uptime = 6;// Аптайм
    NodeInfo node_info = 7;
	
	
    // Соообщение со статусом для компонента
    message ComponentStatus
    {
        string name = 1;// Имя компонента
        uint32 in_packet_count = 2;// Счётчик полученных пакетов
        uint32 out_packet_count = 3;// Счётчик отправленных пакетов
    }

    repeated ComponentStatus component_statuses = 8;

}

//запрос на совершение резервного перехода
message SwitchRequest
{
		
}

// ответ на переход
message SwitchResponse
{
		
}

// Пакет протокола развертывания
message Packet
{
    PacketKind kind = 1;// Тип пакета
    
    // Класс сообщения об ошибке
    message Error
    {
        string message = 1;// Строковое human-readable представление ошибки
    }

    Error error = 2;// Ошибка (если есть)

    // Запрос
    message Request
    {
        oneof Payload
        {
            DeployConfigRequest deploy_config = 1;
            GetConfigRequest get_config = 2;
            StatusRequest status = 3;
            StartRequest start = 4;
            StopRequest stop = 5;
            SwitchRequest switch = 6;
        }
    }

    // Ответ
    message Response
    {
        oneof Payload
        {
            DeployConfigResponse deploy_config = 1;
            GetConfigResponse get_config = 2;
            StatusResponse status = 3;
            StartResponse start = 4;
            StopResponse stop = 5;
            SwitchResponse switch = 6;
        }
    }

    oneof Payload
    {
        Request request = 3;
        Response response = 4;
    }
}
